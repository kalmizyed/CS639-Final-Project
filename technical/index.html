
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../experiments/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Design & Implementation - CS 639 Final Project Summary</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#technical-approach" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="CS 639 Final Project Summary" class="md-header__button md-logo" aria-label="CS 639 Final Project Summary" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CS 639 Final Project Summary
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Design & Implementation
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="CS 639 Final Project Summary" class="md-nav__button md-logo" aria-label="CS 639 Final Project Summary" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    CS 639 Final Project Summary
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Abstract
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Design & Implementation
  

    
  </span>
  
  

      </a>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../experiments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Experiments
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../reflection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reflection
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<div><h1 id="technical-approach">Technical Approach</h1>
<p>This project is organized as a Finite State Machine with states for determining positions to move towards, generating and iterating through a trajectory, and grabbing and dropping blocks.  The FSM states are defined as shown in the figure below, starting with <code>resetToDefault</code>:</p>
<p><img alt="Finite State Machine Diagram" src="../images/fsm.png"></p>
<p>The finite state machine makes use of the following core pillars:</p>
<ul>
<li>Perception</li>
<li>Kinematics</li>
<li>Planning/Trajectory generation</li>
</ul>
<p>The cornerstone of this project is classical perception.  When the controller searches for objects in the camera image, thresholding and contours are used to determine the object centroids from the camera’s perspective.</p>
<p>Forward kinematics is used to determine the location of a detected object based on its pixel location in the camera image.  Inverse kinematics, implemented using the Newton-Raphson algorithm, is used extensively to determine the next joint positions to move towards.</p>
<p>A cubic trajectory generation algorithm is used to ensure smooth and quick motion between two task-space points through configuration-space interpolations. </p>
<p><br></p>
<h1 id="implementation-details">Implementation Details</h1>
<h2 id="environment-setup">Environment Setup</h2>
<p>The environment is implemented as a simulation in Webots based on its sample factory world.  The base modified factory world and every experimental trial world are in this repository under <code>worlds/</code> and can be replayed.</p>
<p>I placed a UR5e robot arm with an attached camera and <em>robotiq_2f85</em> gripper onto a table, then placed a conveyor belt to the right of the UR5e for it to drop blocks onto and a conveyor belt going past the front of the UR5e for it to pick blocks up from.  Both conveyor belts have a speed of <code>0.05 m/s</code>.</p>
<p>Blocks are implemented as solids with a Box geometry and a material with a <code>diffuseColor</code> of <code>(0.8, 0.8, 0.8)</code>, a <code>shininess</code> of <code>0.2</code>, a <code>specularColor</code> of <code>(0, 0, 0)</code>, a <code>transparency</code> of <code>0</code>, an <code>ambientIntensity</code> of <code>0.2</code>, and one of many <code>emissiveColor</code> values depending on the color of the block.</p>
<p>The camera has a <code>fieldOfView</code> of <code>1.05</code>, a <code>width</code> of <code>640</code>, a <code>height</code> of <code>480</code>, a <code>planar</code> projection type, and <code>near</code> and <code>far</code> frustums of <code>0.01</code> and <code>3</code>.</p>
<h2 id="system-design">System Design</h2>
<p>All controller code exists in the repository under <code>controllers/sorting_robot/</code>.  The controller entrypoint is <code>sorting_robot.py</code>.</p>
<p>The finite state machine, defined in <code>helper.fsm_controller.py</code>, acts as the main processing unit for the UR5e, and is called from the main controller in <code>sorting_robot.py</code> at each timestep to run one of its states:</p>
<h3 id="location-setting-states">Location-Setting States</h3>
<p><strong><code>resetToDefault:</code></strong> Set the desired joints directly to the set of joint angles to position the camera above the belt at a sufficient height to see the entire width of the belt.  The joint angle set used is generated from a desired pose in task space on the initial run.  Using preset joint angles rather than running the inverse kinematics algorithm on each call to this state is done both to reduce computation and ensure the joint angles for this position are consistent between runs, as the IK algorithm can at times return an impossible joint angle set depending on the starting position.  Moves to <code>generateTrajectoryFromJoints</code>.</p>
<p><strong><code>moveToDrop:</code></strong> Set the desired joints directly to the set of joints to position the gripped above the output belt.  The joint set used is generated from a pose above the input belt and manually rotated 90 degrees on the first joint since the inverse kinematics algorithm sometimes has troubles generating a valid joint angle set to reach the output belt since it’s decently far from the position objects are grabbed from.  Moves to <code>generateTrajectoryFromJoints</code>.</p>
<p><strong><code>getBlockLocation:</code></strong> Given the pixel location of a particular block on the camera, calculates the position of the block in the camera space via an inverse perspective projection transform based on the camera’s width, height, field of view, and height above the belt.  Then, it sets the desired pose to the position of this block accounting for the object’s height, the gripper’s position relative to the camera, and the location the block will be along the belt by the time the gripper moves to it (using the <code>getLocationAfterMotion()</code> function).  If it’s impossible to grab the block before it moves out of the gripper’s range, moves to <code>resetToDefault</code> to wait for the next block.  Otherwise, moves to <code>generateTrajectory</code> to move towards the block.</p>
<h3 id="trajectory-generation-iteration-states">Trajectory Generation &amp; Iteration States</h3>
<p><strong><code>generateTrajectory:</code></strong> Given a desired pose, uses IK to generate the desired joint positions, then sets up the trajectory interpolation variables <code>t</code>, <code>T</code>, <code>theta_start</code>, and <code>theta_end</code>.  Moves to <code>moveToLocation</code>.</p>
<p><strong><code>generateTrajectoryFromJoints:</code></strong> Given a set of desired joint angles, sets up the trajectory interpolation variables as above.  Moves to <code>moveToLocation</code>.</p>
<p><strong><code>moveToLocation:</code></strong> Given a trajectory interpolation setup from one of the above states, iterates and increments <code>t</code> until <code>t == T</code>, setting the next set of joint angles to move to for the current timestep by calling the interpolation function with the current timestep in the trajectory <code>t</code>, the max timestep <code>T</code>, the start angles, and the end angles.  Once <code>t == T</code>, moves to <code>waitForBlock</code> if at the initial position, <code>dropBlock</code> if at the drop position, or <code>gripBlock</code> otherwise.</p>
<h3 id="other-states">Other States</h3>
<p><strong><code>waitForBlock:</code></strong> Call getPixelLocations() helper function until a block’s centroid is returned, then set the next target to the position of the block that is furthest down the belt.  Move to <code>generateTrajectory</code>.</p>
<p><strong><code>gripBlock:</code></strong> Set the gripper flag to closed.  Wait for a preset number of timesteps before moving to <code>moveToDrop</code>.</p>
<p><strong><code>dropBlock:</code></strong> Set the gripper flag to open.  Wait for a preset number of timesteps before moving to <code>resetToDefault</code>.</p>
<h3 id="helper-functions">Helper Functions</h3>
<p>In addition to the states detailed above, the following helper function is used:</p>
<p><strong><code>getPixelLocations():</code></strong> Given the current camera image and the set of accepted colors, the function finds all objects that match those colors and returns their center pixel coordinates within the camera image.  For each accepted color, the algorithm thresholds each channel of the image against each channel of the color, merges the three channel thresholds, converts the resulting binary image into contours, then uses the moments of each contour to find the centroid of the object represented by the contour.  If a contour touches the edges of the image, it’s discarded since the object may continue beyond the image and the centroid won’t be accurate.  Finally, the function returns every centroid it found across all accepted colors.</p>
<h3 id="trajectory-generation">Trajectory Generation</h3>
<p>These functions, defined in <code>helper.trajectory_generator.py</code>, are called by the FSM:</p>
<p><strong><code>getRequiredTime():</code></strong> Given the start and end joint angles, a preset maximum acceleration and a preset maximum velocity, returns the maximum time any joint will take to interpolate between its start and end angles when speed and acceleration are limited to the maximum values, rounded up to the nearest timestep.</p>
<p><strong><code>getPosition():</code></strong> Given the start and end joint angles, the current trajectory timestep t, and the maximum trajectory timestep T, returns the interpolated joint angles at point t along the trajectory.</p>
<h3 id="kinematics">Kinematics</h3>
<p>These functions, defined in <code>helper.inverse_kinematics.py</code>, are called by the FSM:</p>
<p><strong><code>getInverseKinematics():</code></strong> Given a desired pose in task space and the current joint angles in configuration space, returns a set of joint angles that will place the end effector at the desired pose.  Uses an implementation of the Newton-Raphson algorithm.</p>
<p><strong><code>getFK():</code></strong> Given a set of joint angles, returns the end effector pose.</p></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>